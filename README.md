# KOSPI-SP500 베타 잔차 되돌림 전략

이 프로젝트는 KOSPI가 S&P500 움직임 대비 과하게 오르거나 내렸을 때, 시간이 지나며 다시 평균으로 돌아온다는 가정에 기반합니다.  
숫자와 공식을 몰라도 이해할 수 있도록 아래에 단계별로 설명합니다.

## 한눈에 보는 아이디어
- KOSPI는 보통 S&P500과 함께 움직입니다.
- 하루치 S&P500 변화가 있으면, 그만큼 KOSPI도 움직일 "기대값"이 있습니다.
- 실제 KOSPI가 기대값보다 과하게 움직였으면, "되돌림"을 기대해 반대 포지션을 잡습니다.
- 다만, 시장이 불안한 시기(VIX 급등)나 환율이 급변할 때는 거래를 쉬어 리스크를 줄입니다.

## 데이터 (엑셀 파일)
- 경로: `C:\Users\10845\OneDrive - 이지스자산운용\문서\kospi_sp500_filtered.xlsx`
- 필수 컬럼
  - `공통날짜`: 날짜 (일별)
  - `kospi_t`: KOSPI 종가
  - `SPX_t-1`: S&P500 전일 종가 (시차 보정용)
  - `VIX_t-1`: VIX 전일 값
  - `FX_t`: 원/달러 환율

## 전략을 쉬운 말로 풀면
1. **KOSPI와 S&P500의 동행성 측정**
   - 최근 60일을 기준으로 "KOSPI가 S&P500에 얼마나 민감한지(베타)"를 계산합니다.
2. **예상 움직임 대비 실제 움직임 비교**
   - `예상 KOSPI 움직임 = 베타 × S&P500 변화`
   - `잔차(Residual) = 실제 KOSPI 변화 - 예상 변화`
3. **과열/과매도 판단 (Z-Score)**
   - 잔차가 평소보다 얼마나 큰지 표준화(Z-Score)해서 판단합니다.
   - 값이 너무 크면 과열(숏), 너무 작으면 과매도(롱)로 봅니다.
4. **불안한 시장은 쉬어가기**
   - VIX가 높거나 환율이 급변할 때는 거래를 중단합니다.

## 매매 규칙 (요약)
- 진입
  - Z ≤ -1.0: KOSPI 매수 (롱)
  - Z ≥ +1.0: KOSPI 매도 (숏)
- 청산
  - |Z| ≤ 0.2: 포지션 종료
- 거래 제한
  - VIX가 과도하게 높거나, 환율 변동이 급격할 때는 거래하지 않음
- 체결 가정
  - 신호는 오늘 계산, 실제 매매는 다음 거래일에 실행

## 백테스트 가정
- 베타/잔차 계산: 60일 롤링
- 리스크 필터: 252일 롤링 (VIX 80% 분위, FX 변동 90% 분위)
- 거래 비용: 포지션 변경 시 2bp
- 슬리피지, 레버리지 비용, 공매도 제약 등은 반영하지 않음

## 실행 방법
```bash
python kospi_sp500_beta.py
```
필요 패키지: `pandas`, `numpy`, `openpyxl`, (시각화는 `matplotlib`)

## 리포트 생성 (출력 정리)
```bash
python report.py
```
실행할 때마다 `outputs/YYYYMMDD_HHMMSS/` 폴더가 생성되며, 모든 결과가 해당 폴더에 저장됩니다.

## 현재 데이터 기준 결과 요약
- 데이터 기간: 2020-01-03 ~ 2025-12-26
- 거래일 수: 1,421일

| 항목 | 값 |
| --- | ---: |
| 연환산 수익률 | 2.15% |
| 연환산 변동성 | 9.40% |
| 샤프 | 0.23 |
| 최대낙폭(MDD) | -23.29% |
| 누적 수익률 | 10.11% |
| 시장 노출일 비중 | 23.7% |
| 일간 양(+) 수익 비중 | 11.75% |

참고: 초기 구간은 60일/252일 롤링 윈도우가 필요해 거래가 거의 없으며, 2020~2021년 수익률이 0%로 표시됩니다.

## 결과 시각화
아래 그래프는 `outputs/YYYYMMDD_HHMMSS/` 폴더에 저장되어 있습니다.

- 누적 수익 곡선

![Equity Curve](outputs/YYYYMMDD_HHMMSS/equity_curve.png)

- 최대낙폭 추이

![Drawdown](outputs/YYYYMMDD_HHMMSS/drawdown.png)

- 연도별 수익률

![Annual Returns](outputs/YYYYMMDD_HHMMSS/annual_returns.png)

- 분기별 수익률 히트맵

![Quarterly Returns Heatmap](outputs/YYYYMMDD_HHMMSS/quarterly_returns_heatmap.png)

## 연도별 수익률 (현재 데이터 기준)
| Year | Return |
| --- | ---: |
| 2020 | 0.00% |
| 2021 | 0.00% |
| 2022 | 1.47% |
| 2023 | 7.52% |
| 2024 | -7.03% |
| 2025 | 8.55% |

**해석 포인트**
- 2020~2021년은 롤링 윈도우 확보 기간이라 실질 거래가 거의 없습니다.
- 2022년은 Q2~Q3에서 수익이 났지만 Q4에 크게 밀렸습니다.
- 2023년은 상반기(특히 Q1~Q2)에 성과가 집중됐습니다.
- 2024년은 연중 대부분이 약세로, 전략이 역풍을 맞은 구간입니다.
- 2025년은 Q4에 큰 반등이 나오며 연간 성과를 끌어올렸습니다.

## 분기별 수익률 (현재 데이터 기준)
| Year | Q1 | Q2 | Q3 | Q4 |
| --- | ---: | ---: | ---: | ---: |
| 2020 | 0.00% | 0.00% | 0.00% | 0.00% |
| 2021 | 0.00% | 0.00% | 0.00% | 0.00% |
| 2022 | -0.04% | 4.30% | 5.36% | -7.63% |
| 2023 | 3.83% | 5.37% | 0.20% | -1.93% |
| 2024 | 0.79% | -2.11% | -5.32% | -0.47% |
| 2025 | -5.74% | -2.78% | -4.57% | 24.13% |

**해석 포인트**
- 분기 기준 양(+)의 성과는 24개 중 7개로, 성과가 특정 구간에 집중됩니다.
- 최악 분기: 2022Q4(-7.63%) / 최고 분기: 2025Q4(+24.13%).
- 2024년 Q2~Q3처럼 연속 부진 구간이 있어, 리스크 관리가 중요합니다.

## 펀드매니저 관점 요약
- 이 전략은 "항상" 수익을 내는 모델이 아니라, 특정 국면에서 강합니다.
- 성과가 몇 개 분기에 집중되는 경향이 있어, 포트폴리오 안에서 비중 조절이 필요합니다.
- 최대낙폭이 -23% 수준으로, 단독 운용 시 심리적 부담이 있을 수 있습니다.
- VIX/환율 필터로 위험 시기에 거래를 줄이지만, 그만큼 수익 기회도 줄어듭니다.

## 파일 참고
- 연도별 수익률 CSV: `outputs/YYYYMMDD_HHMMSS/annual_returns.csv`
- 분기별 수익률 CSV: `outputs/YYYYMMDD_HHMMSS/quarterly_returns.csv`
